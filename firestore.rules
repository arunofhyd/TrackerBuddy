rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Rule for user documents.
    // A user can read and write their own document.
    // The team dashboard reads from the 'member_summaries' subcollection,
    // so admins do not need direct read access to other users' documents.
    match /users/{userId} {
      allow read, write: if request.auth.uid == userId;

      // Allow access to history subcollection for archiving
      match /history/{year} {
        allow read, write: if request.auth.uid == userId;
      }
    }

    // Rule for the collection of debug logs.
    // Allows any authenticated user to create a new debug log.
    match /debug_logs/{logId} {
      allow create: if request.auth != null;
    }

    // Rule for team documents.
    // All modifications (create, update, delete) are handled by secure Cloud Functions.
    // Clients only need to read team data.
    match /teams/{teamId} {
      // A user can read a team document if their UID is in the 'members' map.
      // This allows any member (admin or regular) to see the team details.
      allow read: if request.auth.uid in resource.data.members;

      // Rule for the subcollection of member summaries.
      // This data is generated by a Cloud Function for the Team Dashboard.
      match /member_summaries/{summaryId} {
        // Allow the team admin to read the summaries for the team dashboard.
        // We check the 'adminId' field on the parent team document.
        allow read: if get(/databases/$(database)/documents/teams/$(teamId)).data.adminId == request.auth.uid;
      }
    }

    // Configuration document for app-wide settings
    // This allows the frontend to fetch the list of super admins
    match /config/app_config {
      allow read: if request.auth != null;
    }
  }
}
